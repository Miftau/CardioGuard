<!-- templates/book_appointment.html -->
{% extends "base.html" %}
{% block title %}Book Appointment{% endblock %}
{% block sidebar %}
    <!-- Only include the sidebar if a user is logged in -->
    {% if session.get('user_id') or session.get('doctor_id') or session.get('admin_id') %}
        {% include 'sidebar.html' %}
    {% endif %}
{% endblock %}
{% block content %}
<section class="py-8 bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen">
  <div class="container mx-auto px-4 max-w-7xl">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <span class="bg-gradient-to-r from-red-500 to-red-700 p-2 rounded-lg text-white">üìÖ</span>
          Book an Appointment
        </h1>
        <p class="text-gray-600 mt-1">Select a date and time from available slots</p>
      </div>
      <a href="/user/dashboard" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-5 py-2.5 rounded-xl hover:from-gray-600 hover:to-gray-700 shadow-md hover:shadow-lg transition duration-300 text-center min-w-[120px]">
        Back to Dashboard
      </a>
    </div>

    <!-- Date Picker Card -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-10 border border-gray-100">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
        <span class="bg-gradient-to-r from-red-500 to-red-700 p-1 rounded-lg text-white text-sm">üóìÔ∏è</span>
        Select Date
      </h2>
      <div class="flex items-center">
        <input
          id="calendarDate"
          type="date"
          class="border border-gray-300 rounded-xl p-3 w-full max-w-xs focus:outline-none focus:ring-2 focus:ring-red-400 shadow-sm"
          min="{{ (now() or datetime.now()).date().isoformat() }}" <!-- Ensure min date is today -->
        />
      </div>
    </div>

    <!-- Available Slots Section -->
    <div id="doctorsContainer" class="space-y-8">
      <!-- Dynamic doctor sections will be inserted here by JS -->
    </div>

    <!-- Confirmation Form (Initially Hidden) -->
    <div id="confirmationSection" class="hidden mt-12">
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
          <span class="bg-gradient-to-r from-red-500 to-red-700 p-1 rounded-lg text-white text-sm">‚úÖ</span>
          Confirm Your Booking
        </h2>
        <p class="text-gray-600 mb-4" id="confirmationText">You have selected a slot. Please confirm to proceed.</p>
        <!-- NEW: Hidden input for meeting URL (generated on backend) -->
        <input type="hidden" name="meeting_url" id="meetingUrlInput">
        <form method="POST" id="bookForm">
          <!-- NEW: Hidden fields for slot key and doctor ID -->
          <input type="hidden" name="slot_time_key" id="selectedSlotKey">
          <input type="hidden" name="selected_doctor_id" id="selectedDoctorId">
          <div class="flex gap-4">
            <button
              type="submit"
              class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-green-700 shadow-md hover:shadow-lg transition duration-300"
            >
              Confirm Appointment
            </button>
            <button
              type="button"
              id="cancelBooking"
              class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-xl hover:from-gray-600 hover:to-gray-700 shadow-md hover:shadow-lg transition duration-300"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  // Data passed from the backend - Now contains pre-calculated available slots
  const allSlots = {{ slots|tojson }}; // Contains: { slot_key: "YYYY-MM-DD_HH:MM:SS", doctor_id, doctor, specialization, rating, date, start_time, end_time, slot_duration, day_of_week }
  const container = document.getElementById("doctorsContainer");
  const calendar = document.getElementById("calendarDate");
  const confirmationSection = document.getElementById("confirmationSection");
  const bookForm = document.getElementById("bookForm");
  const selectedSlotKey = document.getElementById("selectedSlotKey"); // NEW: Get the hidden slot key input
  const selectedDoctorId = document.getElementById("selectedDoctorId"); // NEW: Get the hidden doctor ID input
  const meetingUrlInput = document.getElementById("meetingUrlInput");
  const confirmationText = document.getElementById("confirmationText");
  const cancelBookingBtn = document.getElementById("cancelBooking");

  // --- Initialize: Show slots for today by default ---
  const today = new Date().toISOString().split('T')[0];
  calendar.value = today;
  renderSlotsByDate(today);

  // --- Render Slots by Date and Group by Doctor ---
  function renderSlotsByDate(date) {
    container.innerHTML = ""; // Clear previous content

    // Filter slots for the selected date
    const filtered = allSlots.filter(s => s.date === date);

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12 bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m4 4V3m4 4V3m2 8a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-gray-600">No available slots for ${date}.</p>
          <p class="text-gray-500 text-sm mt-2">Please select another date.</p>
        </div>
      `;
      confirmationSection.classList.add("hidden"); // Hide confirmation if no slots
      return;
    }

    // Group slots by doctor ID
    const doctors = {};
    filtered.forEach(s => {
      if (!doctors[s.doctor_id]) {
        doctors[s.doctor_id] = {
          doctor: s.doctor,
          specialization: s.specialization,
          rating: s.rating,
          slots: [] // Store slots for this doctor on this specific date
        };
      }
      doctors[s.doctor_id].slots.push(s);
    });

    // Render each doctor's card
    for (const [doctorId, data] of Object.entries(doctors)) {
      const card = document.createElement("div");
      card.className = "bg-white rounded-2xl shadow-lg p-6 border border-gray-100 transition-all duration-300 hover:shadow-xl";

      // --- NEW: Group slots by their time range for a calendar-like view ---
      // Group by start_time to potentially show wider time ranges if slots are consecutive
      // For simplicity, let's just list individual slots as time buttons
      const slotsHTML = data.slots.map(s => `
        <label class="time-slot-label bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 text-blue-700 px-4 py-2 rounded-xl hover:from-blue-100 hover:to-blue-200 hover:border-blue-300 hover:text-blue-800 transition duration-200 shadow-sm cursor-pointer inline-block mr-2 mb-2">
          <input type="radio" name="slot_selection_${doctorId}" value="${s.slot_key}" class="slot-radio hidden" data-doctor-id="${doctorId}" data-time="${s.start_time} - ${s.end_time}">
          ${s.start_time} - ${s.end_time}
        </label>
      `).join("");

      // --- NEW: Render Rating Stars ---
      function renderStars(rating) {
          if (!rating || rating === 'No ratings yet') {
              return '<span class="text-gray-500 text-sm">No ratings yet</span>';
          }
          let starsHTML = '<div class="flex items-center mt-1">';
          const roundedRating = Math.round(rating);
          for (let i = 1; i <= 5; i++) {
              if (i <= roundedRating) {
                  starsHTML += '<span class="text-yellow-500">‚òÖ</span>';
              } else {
                  starsHTML += '<span class="text-gray-300">‚òÜ</span>';
              }
          }
          starsHTML += `<span class="ml-2 text-gray-600 text-sm">(${rating})</span>`;
          starsHTML += '</div>';
          return starsHTML;
      }

      card.innerHTML = `
        <div class="flex items-start mb-4">
          <div class="w-12 h-12 bg-gradient-to-r from-red-100 to-red-200 text-red-700 rounded-xl flex items-center justify-center font-bold text-lg">
            ${data.doctor[0].toUpperCase()}
          </div>
          <div class="ml-4 flex-1">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-lg font-bold text-gray-800">Dr. ${data.doctor}</h3>
                <p class="text-gray-600 text-sm">${data.specialization}</p>
                ${renderStars(data.rating)}
              </div>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-200 pt-4">
          <h4 class="font-semibold text-gray-700 mb-3">Available Time Slots on ${date}:</h4>
          <div class="flex flex-wrap gap-2" id="slots-${doctorId}">
            ${slotsHTML}
          </div>
        </div>
      `;

      container.appendChild(card);
    }

    // Attach event listeners to the newly created time slot radio buttons
    attachTimeSlotEvents();
  }

  // --- Handle Time Slot Selection ---
  function attachTimeSlotEvents() {
    document.querySelectorAll(".slot-radio").forEach(radio => {
      radio.addEventListener("change", e => {
        if (e.target.checked) {
          // Deselect any previously selected slot
          document.querySelectorAll(".time-slot-label").forEach(label => {
            label.classList.remove("bg-gradient-to-r", "from-green-100", "to-green-200", "border-green-400", "text-green-800");
            label.classList.add("bg-gradient-to-r", "from-blue-50", "to-blue-100", "border-blue-200", "text-blue-700");
          });

          // Select the clicked slot's label
          const label = e.target.parentElement;
          label.classList.remove("bg-gradient-to-r", "from-blue-50", "to-blue-100", "border-blue-200", "text-blue-700");
          label.classList.add("bg-gradient-to-r", "from-green-100", "to-green-200", "border-green-400", "text-green-800");

          // Update the hidden form fields with the selected slot key and doctor ID
          selectedSlotKey.value = e.target.value;
          selectedDoctorId.value = e.target.getAttribute("data-doctor-id");

          // NEW: Clear the meeting URL input when a new slot is selected
          meetingUrlInput.value = "";

          // Update confirmation text
          const selectedTime = e.target.getAttribute("data-time");
          const selectedDoctorId = e.target.getAttribute("data-doctor-id");
          // Find the doctor name in the data for confirmation text
          const selectedSlotData = allSlots.find(s => s.slot_key === e.target.value);
          const selectedDoctorName = selectedSlotData ? selectedSlotData.doctor : 'Unknown Doctor';
          confirmationText.textContent = `You have selected an appointment with Dr. ${selectedDoctorName} at ${selectedTime} on ${calendar.value}. Please confirm to proceed.`;

          // Show the confirmation section
          confirmationSection.classList.remove("hidden");

          // Scroll to the confirmation section
          confirmationSection.scrollIntoView({ behavior: "smooth" });
        }
      });
    });
  }

  // --- Calendar Listener ---
  calendar.addEventListener("change", e => {
    renderSlotsByDate(e.target.value);
    confirmationSection.classList.add("hidden"); // Hide confirmation when date changes
  });

  // --- Cancel Booking Listener ---
  cancelBookingBtn.addEventListener("click", e => {
      e.preventDefault();
      // Deselect any selected time slot label
      document.querySelectorAll(".time-slot-label").forEach(label => {
        label.classList.remove("bg-gradient-to-r", "from-green-100", "to-green-200", "border-green-400", "text-green-800");
        label.classList.add("bg-gradient-to-r", "from-blue-50", "to-blue-100", "border-blue-200", "text-blue-700");
      });
      // Clear the selected slot key and doctor ID
      selectedSlotKey.value = "";
      selectedDoctorId.value = "";
      // NEW: Clear the meeting URL input when cancelled
      meetingUrlInput.value = "";
      // Hide the confirmation section
      confirmationSection.classList.add("hidden");
  });

  // --- Form Submission Listener ---
  bookForm.addEventListener("submit", e => {
      // The meeting URL is generated on the backend in app.py during the booking process.
      // This hidden field is prepared here but the value will be set by the backend after successful booking.
      // It's included in the form submission for potential future use or logging if needed,
      // but the actual URL generation happens server-side.
      // No client-side action needed here regarding the meeting URL itself.
      // The form will submit to the /book endpoint as defined in app.py.
  });

</script>
<style>
/* NEW: Style for the time slot labels to look like buttons */
.time-slot-label {
  display: inline-block;
  padding: 0.5rem 1rem;
  margin: 0.25rem;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  text-align: center;
  font-size: 0.875rem; /* text-sm */
  line-height: 1.25rem; /* leading-5 */
  border: 2px solid transparent; /* Ensure border changes are visible */
}

.time-slot-label:hover {
  transform: translateY(-1px); /* Slight lift on hover */
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-sm */
}

/* Style for the selected time slot label */
.time-slot-label input[type="radio"]:checked + .time-slot-label,
.time-slot-label.checked { /* In case you add the class manually */
  background: linear-gradient(to right, #4ade80, #22c55e); /* from-green-400 to-green-500 */
  border-color: #16a34a; /* border-green-600 */
  color: #15803d; /* text-green-700 */
  font-weight: 500; /* font-medium */
}

/* Hide the actual radio button */
.slot-radio {
  display: none;
}
</style>
{% endblock %}