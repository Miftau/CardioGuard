<!-- templates/sidebar.html -->
<div id="sidebar-container"
     class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:z-auto lg:shadow-none"
     aria-labelledby="sidebar-label"
     role="navigation">
  <div class="h-full flex flex-col">
    <!-- Close button for mobile -->
    <div class="lg:hidden p-4 flex justify-end mt-30">
      <button id="sidebar-close" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Top Icons Section -->
    <div class="flex justify-between p-4 border-b border-gray-200">
      <!-- Notifications -->
      <div class="relative" id="notification-bell">
        <a href="#" class="text-gray-700 hover:text-red-500 text-xl block text-center relative" onclick="toggleDropdown('notif-dropdown'); return false;">
          <i class="fas fa-bell"></i>
          <span id="notification-count-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span>
        </a>
        <div id="notif-dropdown" class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 shadow-lg rounded-lg hidden z-50">
          <div class="p-2 text-sm text-gray-700 dark:text-gray-300" id="notification-list">
            Loading...
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div class="relative" id="message-envelope">
        <a href="{{ url_for('messages_page') }}" class="text-gray-700 hover:text-red-500 text-xl block text-center relative">
          <i class="fas fa-envelope"></i>
          <span id="message-count-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span>
        </a>
      </div>
    </div>

    <!-- Navigation Links -->
    <nav class="flex flex-col flex-1 py-4 px-3 overflow-y-auto">
      <ul class="space-y-1">
        <li>
          <a href="
            {% if session.get('role') == 'admin' %}
              {{ url_for('admin_dashboard') }}
            {% elif session.get('role') == 'doctor' %}
              {{ url_for('doctor_dashboard') }}
            {% else %}
              {{ url_for('user_dashboard') }}
            {% endif %}
          " class="flex items-center rounded-lg px-3 py-2.5 text-gray-700 hover:bg-gray-100 transition group">
            <i class="fas fa-home w-8 text-center text-gray-600 group-hover:text-gray-900"></i>
            <span class="ml-3 font-medium">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('edit_profile') }}" class="flex items-center rounded-lg px-3 py-2.5 text-gray-700 hover:bg-gray-100 transition group">
            <i class="fas fa-user w-8 text-center text-gray-600 group-hover:text-gray-900"></i>
            <span class="ml-3 font-medium">Edit Profile</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('pricing') }}" class="flex items-center rounded-lg px-3 py-2.5 text-gray-700 hover:bg-gray-100 transition group">
            <i class="fas fa-credit-card w-8 text-center text-gray-600 group-hover:text-gray-900"></i>
            <span class="ml-3 font-medium">Subscription</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('my_bookings') }}" class="flex items-center rounded-lg px-3 py-2.5 text-gray-700 hover:bg-gray-100 transition group">
            <i class="fas fa-calendar w-8 text-center text-gray-600 group-hover:text-gray-900"></i>
            <span class="ml-3 font-medium">My Bookings</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('messages_page') }}" class="flex items-center rounded-lg px-3 py-2.5 text-gray-700 hover:bg-gray-100 transition group">
            <i class="fas fa-envelope w-8 text-center text-gray-600 group-hover:text-gray-900"></i>
            <span class="ml-3 font-medium">Messages</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('form') }}" class="flex items-center rounded-lg px-3 py-2.5 text-gray-700 hover:bg-gray-100 transition group">
            <i class="fas fa-file-medical w-8 text-center text-gray-600 group-hover:text-gray-900"></i>
            <span class="ml-3 font-medium">Health Prediction</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('chat') }}" class="flex items-center rounded-lg px-3 py-2.5 text-gray-700 hover:bg-gray-100 transition group">
            <i class="fas fa-robot w-8 text-center text-gray-600 group-hover:text-gray-900"></i>
            <span class="ml-3 font-medium">AI Consultation</span>
          </a>
        </li>
        <li class="pt-6 border-t border-gray-200 mt-6">
          <a href="#" onclick="confirmDelete(); return false;" class="flex items-center rounded-lg px-3 py-2.5 text-red-600 hover:bg-red-50 transition group">
            <i class="fas fa-trash w-8 text-center"></i>
            <span class="ml-3 font-medium">Delete Account</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Mobile Overlay -->
<div id="sidebar-overlay"
     class="fixed inset-0 bg-black bg-opacity-40 z-40 lg:hidden hidden transition-opacity duration-300"
     style="opacity: 0; pointer-events: none;">
</div>

<!-- Mobile Toggle Button (outside sidebar, fixed) -->
<button id="sidebar-toggle"
        class="lg:hidden fixed left-4 top-4 z-50 p-2.5 bg-white rounded-lg shadow-md text-gray-700 hover:text-red-500">
  <i class="fas fa-bars text-xl"></i>
</button>

{% if session.get('user_id') or session.get('doctor_id') or session.get('admin_id') %}
    <script>
        function toggleDropdown(id) {
            document.getElementById(id)?.classList.toggle('hidden');
        }

        async function fetchCounts() {
            try {
                const notifRes = await fetch('/api/notifications/count');
                const notifData = await notifRes.json();
                const badge = document.getElementById('notification-count-badge');
                if (notifData.count > 0) {
                    badge.textContent = Math.min(notifData.count, 99);
                    badge.classList.remove('hidden');
                } else badge.classList.add('hidden');

                const msgRes = await fetch('/api/messages/unread_count');
                const msgData = await msgRes.json();
                const msgBadge = document.getElementById('message-count-badge');
                if (msgData.count > 0) {
                    msgBadge.textContent = Math.min(msgData.count, 99);
                    msgBadge.classList.remove('hidden');
                } else msgBadge.classList.add('hidden');
            } catch (e) { console.warn('Notification fetch failed', e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchCounts();
            setInterval(fetchCounts, 30000);

            // --- NEW: Server-Sent Events (SSE) for Real-Time Notifications ---
            console.log("Initializing real-time notifications...");
            const eventSource = new EventSource('/notifications/stream');

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.notifications && data.notifications.length > 0) {
                        console.log("Received new notifications via SSE:", data.notifications);
                        // Trigger a fetch to the existing API endpoint to get the correct count and potentially update UI
                        fetch('/api/notifications/count')
                            .then(response => response.json())
                            .then(newData => {
                                const badge = document.getElementById('notification-count-badge');
                                if (newData.count > 0) {
                                    badge.textContent = Math.min(newData.count, 99);
                                    badge.classList.remove('hidden');
                                    // Optional: Show a visual indicator or toast for new notifications
                                    // Example: Show a simple alert or use a library like Toastr
                                    // alert(`You have ${newData.count} new notifications!`);
                                    // Or update a dropdown list of notifications if you have one
                                    // updateNotificationDropdown(newData.notifications); // Call a function to update the UI
                                } else {
                                    badge.classList.add('hidden');
                                }
                            })
                            .catch(err => console.error('Error fetching notification count after SSE:', err));
                    } else {
                        // Received an empty update (e.g., heartbeat) - can be useful for debugging connection
                        // console.log("SSE heartbeat received, connection alive.");
                    }
                } catch (e) {
                    console.error("Error parsing SSE message:", event.data);
                }
            };

            eventSource.onerror = function(event) {
                if (event.eventPhase === EventSource.CLOSED) {
                    console.log("SSE connection closed.");
                    // Optionally, attempt to reconnect after a delay
                    // setTimeout(() => new EventSource('/notifications/stream'), 5000);
                } else {
                    console.error("SSE connection error:", event);
                    // Optionally, attempt to reconnect after a delay
                    // setTimeout(() => new EventSource('/notifications/stream'), 5000);
                }
            };
        });
    </script>
{% endif %}



<script>
  // Toggle sidebar on mobile
  const sidebar = document.getElementById('sidebar-container');
  const overlay = document.getElementById('sidebar-overlay');
  const toggleBtn = document.getElementById('sidebar-toggle');
  const closeBtn = document.getElementById('sidebar-close');

  function openSidebar() {
    sidebar.classList.remove('-translate-x-full');
    sidebar.classList.add('translate-x-0');
    overlay.classList.remove('hidden');
    setTimeout(() => {
      overlay.style.opacity = '1';
      overlay.style.pointerEvents = 'auto';
    }, 10);
  }

  function closeSidebar() {
    sidebar.classList.remove('translate-x-0');
    sidebar.classList.add('-translate-x-full');
    overlay.style.opacity = '0';
    overlay.style.pointerEvents = 'none';
    setTimeout(() => {
      overlay.classList.add('hidden');
    }, 300);
  }

  toggleBtn?.addEventListener('click', openSidebar);
  closeBtn?.addEventListener('click', closeSidebar);
  overlay?.addEventListener('click', closeSidebar);

  // Close dropdowns when sidebar closes
  function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    if (dropdown) dropdown.classList.toggle('hidden');
  }

    // Load notifications (only if user is logged in)
  document.addEventListener('DOMContentLoaded', () => {
    // Only fetch if sidebar is present (i.e., user is logged in)
    if (!document.getElementById('sidebar-container')) return;

    fetch('{{ url_for("get_notification_count") }}')
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        const list = document.getElementById('notification-list');
        const badge = document.getElementById('notification-count-badge');
        if (!list || !badge) return;

        if (data.notifications?.length > 0) {
          list.innerHTML = data.notifications.map(n => `
            <div class="p-3 hover:bg-gray-50 border-b">
              <p class="font-medium text-sm">${n.message || 'New notification'}</p>
              <p class="text-xs text-gray-600 mt-1">${new Date(n.created_at).toLocaleString()}</p>
            </div>
          `).join('');
          badge.textContent = data.count || data.notifications.length;
          badge.classList.remove('hidden');
        } else {
          list.innerHTML = '<p class="p-4 text-center text-gray-500">No notifications</p>';
          badge.classList.add('hidden');
        }
      })
      .catch(() => {
        const list = document.getElementById('notification-list');
        if (list) list.innerHTML = '<p class="p-4 text-center text-gray-500">Failed to load</p>';
      });
  });

  // Confirm delete
  function confirmDelete() {
    if (confirm('Are you sure you want to delete your account? This cannot be undone.')) {
      window.location.href = "{{ url_for('delete_account') }}";
    }
  }

</script>