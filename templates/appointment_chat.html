<!-- templates/appointment_chat.html -->
{% extends "base.html" %}
{% block title %}Chat - Appointment #{{ appointment.id }}{% endblock %}
{% block sidebar %}
    <!-- Only include the sidebar if a user is logged in -->
    {% if session.get('user_id') or session.get('doctor_id') or session.get('admin_id') %}
        {% include 'sidebar.html' %}
    {% endif %}
{% endblock %}
{% block content %}
<section class="py-8 bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen">
  <div class="container mx-auto px-4 max-w-7xl">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <span class="bg-gradient-to-r from-red-500 to-red-700 p-2 rounded-lg text-white">ðŸ’¬</span>
          Chat with Dr. {{ other_user.name }}
        </h1>
        <p class="text-gray-600 mt-1">Appointment on {{ appointment.appointment_time[:16] }} (Status: {{ appointment.status | title }})</p>
      </div>
      <a href="{{ url_for('user_dashboard' if session.get('role') == 'user' else 'doctor_dashboard') }}" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-5 py-2.5 rounded-xl hover:from-gray-600 hover:to-gray-700 shadow-md hover:shadow-lg transition duration-300 text-center min-w-[120px]">
        Back to Dashboard
      </a>
    </div>

    <!-- Chat Container -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 flex flex-col h-[70vh]">
      <!-- Chat Messages Area -->
      <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 border border-gray-200 rounded-lg mb-4 bg-gray-50">
        {% if messages %}
          {% for msg in messages %}
            {% set is_from_current_user = msg.sender_id == session.get('user_id') %}
            <div class="flex mb-4 {% if is_from_current_user %}justify-end{% else %}justify-start{% endif %}">
              <div class="max-w-xs md:max-w-md lg:max-w-lg rounded-lg p-3 {% if is_from_current_user %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-800{% endif %}">
                <p class="text-sm">{{ msg.message }}</p>
                <p class="text-xs mt-1 {% if is_from_current_user %}text-blue-200{% else %}text-gray-500{% endif %}">{{ msg.timestamp[:16] }}</p>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-gray-500 text-center py-8">No messages yet. Start the conversation!</p>
        {% endif %}
      </div>

      <!-- Chat Input Area -->
      <form method="POST" class="flex gap-2">
        <input
          type="text"
          name="message"
          placeholder="Type your message..."
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400"
          required
        />
        <button
          type="submit"
          class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-2 rounded-lg hover:from-red-600 hover:to-red-700 shadow-md transition duration-300"
        >
          Send
        </button>
      </form>
    </div>
  </div>
</section>

<script>
// Auto-scroll to the bottom of the messages container on load and after new messages are added
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
});

// If you implement real-time updates via SSE or WebSocket later,
// you would add code here to append new messages and scroll down.
</script>
{% endblock %}